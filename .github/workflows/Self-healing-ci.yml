name: "Self-healing-ci"

on:
  # Deze workflow draait als een andere workflow klaar is
  workflow_run:
    # PAS DIT AAN naar de namen van jouw workflows
    workflows:
      - "codeql"
      - "atadog-synthetics"
      - "docker-image"
      - "docker-publish"
      - "label"
      - "manual"
      - "node.js"
      - "sonarqube"
      - "super-linter"
    types:
      - completed

jobs:
  ai_self_heal:
    # Alleen draaien als de andere workflow echt gefaald is
    if: github.event.workflow_run.conclusion == 'failure'
    runs-on: ubuntu-latest

    permissions:
      contents: write   # om code te kunnen committen & pushen
      actions: read     # om logs/workflow-info te kunnen lezen

    env:
      # Jouw secrets
      OPENAI_API_KEY: ${{ secrets.MMC_OPENAI_API_KEY }}
      MMC_GITHUB_TOKEN_FULL: ${{ secrets.MMC_GITHUB_TOKEN_FULL }}
      LOGS_URL: ${{ github.event.workflow_run.logs_url }}

    steps:
      - name: Checkout van de branch die faalde
        uses: actions/checkout@v4
        with:
          # Repo + branch van de gefaalde workflow_run
          repository: ${{ github.event.workflow_run.head_repository.full_name }}
          ref: ${{ github.event.workflow_run.head_branch }}
          token: ${{ secrets.MMC_GITHUB_TOKEN_FULL }}
          fetch-depth: 0

      - name: Download logs van gefaalde workflow
        run: |
          if [ -z "$LOGS_URL" ]; then
            echo "Geen logs_url gevonden in event."
            exit 0
          fi

          echo "Download logs from: $LOGS_URL"

          # Download zip met logs
          curl -L \
            -H "Authorization: Bearer $MMC_GITHUB_TOKEN_FULL" \
            -H "Accept: application/vnd.github+json" \
            "$LOGS_URL" \
            --output workflow-logs.zip

          mkdir -p workflow-logs
          unzip -q workflow-logs.zip -d workflow-logs || true

          # Combineer alle .txt logs in één bestand
          find workflow-logs -type f -name '*.txt' -exec cat {} + > workflow-logs.txt || true

          echo "Eerste 200 regels van de logs:"
          head -n 200 workflow-logs.txt || echo "Geen logbestand gevonden"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Installeer Python dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install openai

      - name: Genereer AI-fix patch op basis van logs + broncode
        id: ai_fix
        run: |
          python << 'PY'
          import os
          from pathlib import Path
          from textwrap import dedent

          from openai import OpenAI

          api_key = os.environ.get("OPENAI_API_KEY")
          if not api_key:
            raise SystemExit("Geen OPENAI_API_KEY (MMC_OPENAI_API_KEY) ingesteld in secrets.")

          client = OpenAI(api_key=api_key)

          # Lees workflow-logs (alle workflows, niet alleen tests)
          logs_path = Path("workflow-logs.txt")
          logs = ""
          if logs_path.exists():
            logs = logs_path.read_text(encoding="utf-8")
          else:
            logs = "Geen logs gevonden."

          # Verzamel broncode, maar sla workflows zelf over
          root = Path(".")
          allowed_ext = {
              ".js", ".ts", ".tsx", ".jsx",
              ".py",
              ".java",
              ".go",
              ".rb",
              ".php",
              ".cs",
              ".rs",
              ".cpp", ".cc", ".c", ".h", ".hpp",
              ".kt", ".kts"
          }

          skip_dirs = {
              ".git",
              ".github",          # hierdoor raken we .github/workflows NIET aan
              "node_modules",
              "dist",
              "build",
              "out",
              ".venv",
              "venv",
              "coverage",
              "__pycache__"
          }

          code_snippets = []

          for path in root.rglob("*"):
            if not path.is_file():
              continue
            if path.suffix not in allowed_ext:
              continue

            # sla directories over (geen workflows modificeren)
            if any(part in skip_dirs for part in path.parts):
              continue

            try:
              content = path.read_text(encoding="utf-8", errors="ignore")
            except Exception:
              continue

            # Beperk lengte per bestand
            if len(content) > 4000:
              content = content[:4000] + "\n// ... ingekort ..."

            snippet = f"--- {path.as_posix()} ---\n{content}"
            code_snippets.append(snippet)

            # Max aantal bestanden in context (om tokens te beperken)
            if len(code_snippets) >= 10:
              break

          context = "\n\n".join(code_snippets) if code_snippets else "Geen bronbestanden gevonden."

          prompt = dedent(f"""
          Je bent een zeer ervaren software engineer en CI/CD expert.

          Er is een GitHub Actions workflow gefaald. Hier zijn de relevante logs
          (build, tests, lint, deploy, enz.):

          === WORKFLOW LOGS BEGIN ===
          {logs}
          === WORKFLOW LOGS EINDE ===

          Hieronder zie je een selectie van de broncodebestanden van de repository
          (GEEN workflow-bestanden):

          === SOURCE CODE BEGIN ===
          {context}
          === SOURCE CODE EINDE ===

          Doel:
          - Analyseer de fout(en) uit de logs.
          - Bedenk een codewijziging in de broncode die de fout oplost
            (bijv. test-fix, bugfix, type-fout, import, configuratie in code, etc.).
          - PAS GEEN bestanden aan in '.github/' of '.github/workflows/'.
            Richt je uitsluitend op de broncode (app, libs, tests).

          Output:
          - Geef een geldige patch in unified diff (git diff) formaat.
          - Gebruik paden relatief vanaf de repo-root (zoals ze hierboven staan).
          - Gebruik ALLEEN bestanden die al bestaan.
          - Voeg GEEN extra tekst of uitleg toe, alleen de diff.

          Voorbeeld structuur (niet letterlijk overnemen):

          diff --git a/src/example.js b/src/example.js
          index e69de29..b123abc 100644
          --- a/src/example.js
          +++ b/src/example.js
          @@ -1,3 +1,5 @@
          -oude regel
          +nieuwe regel

          Herinnering: geen `.github/` of workflow-bestanden wijzigen.
          """)

          print("Roep OpenAI aan voor patch-generatie...")
          response = client.responses.create(
              model="gpt-4.1-mini",
              input=prompt,
              temperature=0.2,
          )

          text = ""
          # response.output is een lijst; we halen alle tekstblokken eruit
          for item in response.output:
            for block in getattr(item, "content", []):
              if getattr(block, "type", "") == "output_text":
                text += block.text

          patch = text.strip()

          if not patch or "diff --git" not in patch:
            print("Geen bruikbare patch ontvangen van AI.")
            raise SystemExit(0)

          Path("ai-fix.patch").write_text(patch, encoding="utf-8")
          print("Gegenereerde patch:")
          print(patch)
          PY

      - name: Controleer of patch bestaan
        id: has_patch
        run: |
          if [ -f ai-fix.patch ]; then
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Pas AI patch toe
        if: steps.has_patch.outputs.found == 'true'
        id: apply_patch
        run: |
          echo "Probeer patch toe te passen..."
          cat ai-fix.patch

          set +e
          git apply --whitespace=nowarn ai-fix.patch
          status=$?
          set -e

          if [ $status -ne 0 ]; then
            echo "Patch kon niet automatisch toegepast worden."
            echo "success=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Patch succesvol toegepast."
          echo "success=true" >> $GITHUB_OUTPUT

      - name: Commit en push AI-fix naar dezelfde branch
        if: steps.apply_patch.outputs.success == 'true'
        run: |
          # Kijk of er echt wijzigingen zijn
          if git diff --quiet; then
            echo "Geen wijzigingen na het toepassen van de patch."
            exit 0
          fi

          BRANCH="${{ github.event.workflow_run.head_branch }}"

          git config user.name "ai-self-healing-bot"
          git config user.email "ai-self-healing-bot@users.noreply.github.com"

          git status
          git add .
          git commit -m "AI self-healing: automatische fix voor gefaalde workflow"
          git push origin "HEAD:${BRANCH}"

          echo "AI-fix gepusht naar branch: ${BRANCH}. Nieuwe workflow-run wordt automatisch gestart."
